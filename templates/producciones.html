{% extends "base.html" %}


{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.css">
<script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.full.min.js"></script>

<style>
body { font-family: Arial, sans-serif; background:#f2f4f7; padding:20px; }
button { padding:8px 15px; border:none; background:#0057b7; color:white; border-radius:5px; cursor:pointer; }
button:hover { background:#003f87; }
.controles { display:flex; gap:10px; margin-bottom:10px; }
#aexcel { width:100%; height:650px; background:white; }
h2 { text-align:center; }
</style>




<h2>ğŸ“Š Hoja de ProducciÃ³n</h2>

<div class="controles">
  <button onclick="saveAll()">ğŸ’¾ Guardar</button>
  <button onclick="descargarExcel()">ğŸ“¥ Descargar Excel</button>
</div>

<div id="aexcel"></div>

<script>
let hot;

// Factores por presentaciÃ³n
const FACTORES = {
    "Litro": 1,
    "Galon": 4,
    "Caja": 25,
    "Cubeta": 20,
    "EstaÃ±on": 200
};

// Frutas vÃ¡lidas
const FRUTAS = [
    "Cas","Carambola","Fresa","Guanabana","Guayaba","Kiwi","Mango","Maracuya",
    "Mixto Frutas","Mora","Naranja","Naranjilla","Naranja Zanahoria","Papaya",
    "PiÃ±a","PiÃ±a Colada","PiÃ±a Con Arroz","Tamarindo","Limon Mesino",
    "Limon Mandarino","Frutos Rojos","Banano"
];

async function cargar() {
    const res = await fetch("/api/producciones");
    const data = await res.json();

    const tabla = data.map(r => ({
        id: r.id || null,
        fecha: r.fecha || "",
        fruta: r.fruta || "",
        tanda: r.tanda || "",
        codigo_lote: r.codigo_lote || "",
        proceso: r.proceso || "",
        presentacion: r.presentacion || "",
        cantidad: r.cantidad || 0,
        kilos_totales: r.kilos_totales || 0,
        ph: r.ph || 0,
        brix: r.brix || 0,
        azucar_kg: r.azucar_kg || 0,
        pectina_kg: r.pectina_kg || 0,
        observaciones: r.observaciones || ""
    }));

    hot = new Handsontable(document.getElementById("aexcel"), {
        data: tabla,
        colHeaders: [
            "Fecha","Fruta","Tanda","Lote","Proceso","PresentaciÃ³n",
            "Cantidad","Kilos Totales","PH","Brix","AzÃºcar (KG)","Pectina","Observaciones"
        ],
        columns: [
            { data: "fecha", type: "date", dateFormat: "YYYY-MM-DD", correctFormat: true },
            { data: "fruta", type: "dropdown", source: FRUTAS, strict: true },
            { data: "tanda", type: "text" },
            { data: "codigo_lote", type: "text" },
            { data: "proceso", type: "text" },
            { data: "presentacion", type: "dropdown", source: Object.keys(FACTORES), strict: true },
            { data: "cantidad", type: "numeric", numericFormat: { pattern: "0.00" } },
            { data: "kilos_totales", type: "numeric", numericFormat: { pattern: "0.00" }, readOnly: true },
            { data: "ph", type: "numeric", numericFormat: { pattern: "0.00" } },
            { data: "brix", type: "numeric", numericFormat: { pattern: "0.00" } },
            { data: "azucar_kg", type: "numeric", numericFormat: { pattern: "0.00" } },
            { data: "pectina_kg", type: "numeric", numericFormat: { pattern: "0.00" } },
            { data: "observaciones", type: "text" }
        ],
        rowHeaders: true,
        contextMenu: true,            // MenÃº completo: insertar/eliminar filas/columnas
        manualRowMove: true,          // Mover filas
        manualColumnMove: true,       // Mover columnas
        manualRowResize: true,        // Redimensionar filas
        manualColumnResize: true,     // Redimensionar columnas
        copyPaste: true,              // Copiar y pegar como Excel
        formulas: true,               // Permite usar fÃ³rmulas simples
        dropdownMenu: true,
        filters: true,
        stretchH: "all",
        height: 650,
        licenseKey: "non-commercial-and-evaluation",
        afterChange: function(changes, source) {
            if (!changes || source === "loadData") return;
            changes.forEach(([row, prop]) => {
                if (prop === "cantidad" || prop === "presentacion") {
                    const cant = parseFloat(hot.getDataAtRowProp(row, "cantidad")) || 0;
                    const pres = hot.getDataAtRowProp(row, "presentacion");
                    const factor = FACTORES[pres] || 1;
                    hot.setDataAtRowProp(row, "kilos_totales", cant * factor);
                }
            });
        }
    });
}

function addRow() {
    hot.alter("insert_row", hot.countRows());
}

async function saveAll() {
    if (!hot) return;
    const data = hot.getSourceData();
    const payload = data
        .filter(r => r.fruta || r.codigo_lote)
        .map(r => ({
            id: r.id || null,
            fecha: r.fecha || null,
            fruta: r.fruta || null,
            tanda: r.tanda || null,
            codigo_lote: r.codigo_lote || null,
            proceso: r.proceso || null,
            presentacion: r.presentacion || null,
            cantidad: Number(r.cantidad) || 0,
            kilos_totales: Number(r.kilos_totales) || 0,
            ph: Number(r.ph) || 0,
            brix: Number(r.brix) || 0,
            azucar_kg: Number(r.azucar_kg) || 0,
            pectina_kg: Number(r.pectina_kg) || 0,
            observaciones: r.observaciones || ""
        }));

    payload.forEach(r => {
        if (r.fecha && typeof r.fecha !== "string") {
            r.fecha = new Date(r.fecha).toISOString().split("T")[0];
        }
    });

    const res = await fetch("/api/producciones/bulk", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    });

    if (res.ok) {
        alert("âœ… Guardado correctamente");
        cargar();
    } else {
        alert("âŒ Error al guardar");
    }
}

function descargarExcel() {
    window.location.href = "/exportar_excel";
}

cargar();
</script>


{% endblock %}
