{% extends "base.html" %}

{% block subtitulo %}Inicio{% endblock %}

{% block content %}

<style>
/* ===== ESTILOS ===== */
body {
    font-family: Arial, sans-serif;
    background: #f2f4f7;
    padding: 20px;
}

/* CAJA */
.box {
    max-width: 900px;
    margin: auto;
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,.1);
}

button {
    padding: 10px 16px;
    font-size: 16px;
    cursor: pointer;
}

/* TABLA */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
th {
    background: #0057b7;
    color: white;
    padding: 10px;
}
td {
    padding: 8px;
}
tr:nth-child(even){ background: #eaf3ff; }
tr:nth-child(odd){ background: white; }
tr:hover{ background: #cfe0ff; cursor: pointer; }
</style>

<!-- CONTENIDO PRINCIPAL -->
<div class="box">
    <h3> Calendario juliano</h3>
    <label>Fecha</label><br>
    <input type="date" id="fecha_cal">
    <input type="text" id="codigo_dia" readonly placeholder="C贸digo del d铆a">
    <br><br>

    <h3> Productos</h3>
    <button onclick="abrirProductos()">Ver productos</button>
</div>

<!-- MODAL PRODUCTOS -->
<div id="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5);">
  <div style="background:white; margin:4% auto; padding:20px; width:85%; max-height:85%; overflow:auto; border-radius:8px;">

    <div style="display:flex; gap:8px; margin-bottom:10px;">
      <button onclick="filtrar('ALL')">Todos</button>
      <button onclick="filtrar('PT')">Pulpas</button>
      <button onclick="filtrar('PP')">Pures</button>
      <button onclick="ordenar()">ASC / DESC</button>
      <button style="margin-left:auto;background:#444;color:white" onclick="cerrarProductos()">Cerrar</button>
    </div>

    <table>
      <thead>
        <tr>
            <th>C贸digo</th>
            <th>Descripci贸n</th>
        </tr>
      </thead>
      <tbody id="tablaProductos"></tbody>
    </table>
  </div>
</div>

<!-- PROGRAMACIN SEMANAL -->
{% if ultima_programacion_id %}
    <div class="box" style="margin-top:20px;">
        <h3> Programaci贸n Semanal</h3>
        <img src="{{ url_for('mostrar_programacion', id=ultima_programacion_id) }}" 
             style="width:100%; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
    </div>
{% else %}
    <div class="box" style="margin-top:20px;">
        <h3> Programaci贸n Semanal</h3>
        <p>No hay programaci贸n disponible.</p>
    </div>
{% endif %}

<script>
let productos = [];
let filtro = "ALL";
let asc = true;

/* ===== FUNCIONES PRODUCTOS ===== */
function abrirProductos(){
    modal.style.display="block";
    cargarProductos();
}

function cerrarProductos(){
    modal.style.display="none";
}

async function cargarProductos(){
    tablaProductos.innerHTML = "<tr><td colspan='2'>Cargando...</td></tr>";
    const res = await fetch("/api/productos");
    productos = await res.json();
    renderProductos();
}

function filtrar(t){
    filtro = t;
    renderProductos();
}

function ordenar(){
    asc = !asc;
    renderProductos();
}

function renderProductos(){
    let data = [...productos];
    if(filtro !== "ALL") data = data.filter(p => p.codigo.startsWith(filtro));
    data.sort((a,b)=> asc ? a.codigo.localeCompare(b.codigo) : b.codigo.localeCompare(a.codigo));
    tablaProductos.innerHTML = "";
    data.forEach(p=>{
        tablaProductos.innerHTML += `
        <tr>
            <td>${p.codigo}</td>
            <td>${p.descripcion}</td>
        </tr>`;
    });
}

/* ===== EVENTO CALENDARIO ===== */
fecha_cal.addEventListener("change", async e=>{
    const res = await fetch(`/api/calendario/${e.target.value}`);
    const d = await res.json();
    codigo_dia.value = d.codigo_dia || "No existe";
});
</script>

{% endblock %}
